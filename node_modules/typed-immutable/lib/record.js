(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "./typed", "immutable"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("./typed"), require("immutable"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.typed, global.immutable);
    global.record = mod.exports;
  }
})(this, function (exports, _typed, _immutable) {
  "use strict";

  var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; })();

  var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

  var _get = function get(_x, _x2, _x3) { var _again = true; _function: while (_again) { var object = _x, property = _x2, receiver = _x3; desc = parent = getter = undefined; _again = false; if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { _x = parent; _x2 = property; _x3 = receiver; _again = true; continue _function; } } else if ("value" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } } };

  function _defaults(obj, defaults) { var keys = Object.getOwnPropertyNames(defaults); for (var i = 0; i < keys.length; i++) { var key = keys[i]; var value = Object.getOwnPropertyDescriptor(defaults, key); if (value && value.configurable && obj[key] === undefined) { Object.defineProperty(obj, key, value); } } return obj; }

  function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

  function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

  function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) _defaults(subClass, superClass); }

  var Keyed = _immutable.Iterable.Keyed;

  var Getter = function Getter(key) {
    return function () {
      return this.get(key);
    };
  };

  var Setter = function Setter(key) {
    return function (value) {
      if (!this.__ownerID) {
        throw TypeError("Cannot set on an immutable record.");
      }
      this.set(key, value);
    };
  };

  var $store = _typed.Typed.store;
  var $type = _typed.Typed.type;
  var $step = _typed.Typed.step;
  var $init = _typed.Typed.init;
  var $result = _typed.Typed.result;
  var $read = _typed.Typed.read;
  var $label = _typed.Typed.label;
  var $empty = _typed.Typed.empty;
  var $typeName = _typed.Typed.typeName;
  var $typeSignature = _typed.Typed.typeSignature;

  var IterableKeyedBase = function IterableKeyedBase() {};
  IterableKeyedBase.prototype = _immutable.Iterable.Keyed.prototype;

  var TypedRecord = (function (_IterableKeyedBase) {
    function TypedRecord() {
      _classCallCheck(this, TypedRecord);

      _get(Object.getPrototypeOf(TypedRecord.prototype), "constructor", this).call(this);
    }

    _inherits(TypedRecord, _IterableKeyedBase);

    _createClass(TypedRecord, [{
      key: _typed.Typed.init,
      value: function value() {
        return (0, _typed.construct)(this).asMutable();
      }
    }, {
      key: _typed.Typed.result,
      value: function value(result) {
        return result.asImmutable();
      }
    }, {
      key: _typed.Typed.read,
      value: function value(structure) {
        var Type = this.constructor;

        if (structure instanceof Type && structure && structure.constructor === Type) {
          return structure;
        }

        if (structure === null || structure && typeof structure !== "object") {
          return TypeError("Invalid data structure \"" + structure + "\" was passed to " + this[$typeName]());
        }

        var seq = (0, _immutable.Seq)(structure);
        var type = this[$type];
        var isEmpty = seq.size === 0;

        if (isEmpty && this[$empty]) {
          return this[$empty];
        }

        var record = undefined;
        for (var key in type) {
          var fieldType = type[key];
          var value = seq.has(key) ? seq.get(key) : this.get(key);
          var result = fieldType[$read](value);

          if (result instanceof TypeError) {
            return TypeError("Invalid value for \"" + key + "\" field:\n " + result.message);
          }

          record = this[$step](record || this[$init](), [key, result]);
        }

        record = this[$result](record);

        if (isEmpty) {
          this[$empty] = record;
        }

        return record;
      }
    }, {
      key: _typed.Typed.step,
      value: function value(result, _ref) {
        var _ref2 = _slicedToArray(_ref, 2);

        var key = _ref2[0];
        var _value = _ref2[1];

        var store = result[$store] ? result[$store].set(key, _value) : new _immutable.Map([[key, _value]]);

        if (result[$store] === store) {
          return result;
        }

        var record = result.__ownerID ? result : (0, _typed.construct)(result);
        record[$store] = store;

        return record;
      }
    }, {
      key: _typed.Typed.typeSignature,
      value: function value() {
        var type = this[$type];
        var body = [];
        for (var key in type) {
          body.push(key + ": " + type[key][$typeName]());
        }

        return "Typed.Record({" + body.join(", ") + "})";
      }
    }, {
      key: _typed.Typed.typeName,
      value: function value() {
        return this[$label] || this[$typeSignature]();
      }
    }, {
      key: "toString",
      value: function toString() {
        return this.__toString(this[$typeName]() + "({", "})");
      }
    }, {
      key: "has",
      value: function has(key) {
        return !!this[$type][key];
      }
    }, {
      key: "get",
      value: function get(key, defaultValue) {
        return !this[$type][key] ? defaultValue : !this[$store] ? defaultValue : this[$store].get(key, defaultValue);
      }
    }, {
      key: "clear",
      value: function clear() {
        if (this.__ownerID) {
          this[$store] && this[$store].clear();
          return this;
        }

        return this[$empty] || (this[$empty] = new this.constructor());
      }
    }, {
      key: "remove",
      value: function remove(key) {
        return this[$type][key] ? this.set(key, void 0) : this;
      }
    }, {
      key: "set",
      value: function set(key, value) {
        var fieldType = this[$type][key];

        if (!fieldType) {
          throw TypeError("Cannot set unknown field \"" + key + "\" on \"" + this[$typeName]() + "\"");
        }

        var result = fieldType[$read](value);

        if (result instanceof TypeError) {
          throw TypeError("Invalid value for " + key + " field: " + result.message);
        }

        return this[$step](this, [key, result]);
      }
    }, {
      key: "__iterator",
      value: function __iterator(type, reverse) {
        var _this = this;

        return Keyed(this[$type]).map(function (_, key) {
          return _this.get(key);
        }).__iterator(type, reverse);
      }
    }, {
      key: "__iterate",
      value: function __iterate(f, reverse) {
        var _this2 = this;

        return Keyed(this[$type]).map(function (_, key) {
          return _this2.get(key);
        }).__iterate(f, reverse);
      }
    }, {
      key: "__ensureOwner",
      value: function __ensureOwner(ownerID) {
        if (ownerID === this.__ownerID) {
          return this;
        }

        var store = this[$store] && this[$store].__ensureOwner(ownerID);
        var result = !ownerID ? this : (0, _typed.construct)(this);

        result.__ownerID = ownerID;
        result[$store] = store;
        return result;
      }
    }, {
      key: "wasAltered",
      value: function wasAltered() {
        return this[$store].wasAltered();
      }
    }]);

    return TypedRecord;
  })(IterableKeyedBase);

  var Record = function Record(descriptor, label) {
    if (descriptor && typeof descriptor === "object") {
      var type = Object.create(null);
      var _keys = Object.keys(descriptor);
      var size = _keys.length;

      if (size > 0) {
        var _properties;

        var _ret = (function () {
          var properties = (_properties = {
            size: { value: size }
          }, _defineProperty(_properties, $type, { value: type }), _defineProperty(_properties, $label, { value: label }), _properties);

          var index = 0;
          while (index < size) {
            var key = _keys[index];
            var fieldType = (0, _typed.typeOf)(descriptor[key]);

            if (fieldType) {
              type[key] = fieldType;
              properties[key] = { get: Getter(key), set: Setter(key), enumerable: true };
            } else {
              throw TypeError("Invalid field descriptor provided for a \"" + key + "\" field");
            }

            index = index + 1;
          }

          var RecordType = function RecordType(structure) {
            var isNew = this instanceof RecordType;
            var constructor = isNew ? this.constructor : RecordType;

            if (structure instanceof constructor) {
              return structure;
            }

            var type = constructor.prototype;
            var result = type[$read](structure);

            if (result instanceof TypeError) {
              throw result;
            }

            if (isNew) {
              this[$store] = result[$store];
            } else {
              return result;
            }
          };

          properties.constructor = { value: RecordType };
          RecordType.prototype = Object.create(RecordPrototype, properties);
          var prototype = RecordType.prototype;

          return {
            v: RecordType
          };
        })();

        if (typeof _ret === "object") return _ret.v;
      } else {
        throw TypeError("Typed.Record descriptor must define at least on field");
      }
    } else {
      throw TypeError("Typed.Record must be passed a descriptor of fields");
    }
  };
  exports.Record = Record;
  Record.Type = TypedRecord;
  Record.prototype = TypedRecord.prototype;
  var RecordPrototype = TypedRecord.prototype;

  RecordPrototype[_typed.Typed.DELETE] = RecordPrototype.remove;

  // Large part of the Record API is implemented by Immutabel.Map
  // and is just copied over.
  RecordPrototype.deleteIn = _immutable.Map.prototype.deleteIn;
  RecordPrototype.removeIn = _immutable.Map.prototype.removeIn;
  RecordPrototype.merge = _immutable.Map.prototype.merge;
  RecordPrototype.mergeWith = _immutable.Map.prototype.mergeWith;
  RecordPrototype.mergeIn = _immutable.Map.prototype.mergeIn;
  RecordPrototype.mergeDeep = _immutable.Map.prototype.mergeDeep;
  RecordPrototype.mergeDeepWith = _immutable.Map.prototype.mergeDeepWith;
  RecordPrototype.mergeDeepIn = _immutable.Map.prototype.mergeDeepIn;
  RecordPrototype.setIn = _immutable.Map.prototype.setIn;
  RecordPrototype.update = _immutable.Map.prototype.update;
  RecordPrototype.updateIn = _immutable.Map.prototype.updateIn;
  RecordPrototype.withMutations = _immutable.Map.prototype.withMutations;
  RecordPrototype.asMutable = _immutable.Map.prototype.asMutable;
  RecordPrototype.asImmutable = _immutable.Map.prototype.asImmutable;

  // Large chuck of API inherited from Iterable does not makes
  // much sense in the context of records so we undefine it.
  RecordPrototype.map = void 0;
  RecordPrototype.filter = void 0;
  RecordPrototype.filterNot = void 0;
  RecordPrototype.flip = void 0;
  RecordPrototype.mapKeys = void 0;
  RecordPrototype.mapEntries = void 0;
  RecordPrototype.sort = void 0;
  RecordPrototype.sortBy = void 0;
  RecordPrototype.reverse = void 0;
  RecordPrototype.slice = void 0;
  RecordPrototype.butLast = void 0;
  RecordPrototype.flatMap = void 0;
  RecordPrototype.flatten = void 0;
  RecordPrototype.rest = void 0;
  RecordPrototype.skip = void 0;
  RecordPrototype.skipLast = void 0;
  RecordPrototype.skipWhile = void 0;
  RecordPrototype.skipUntil = void 0;
  RecordPrototype.sortBy = void 0;
  RecordPrototype.take = void 0;
  RecordPrototype.takeLast = void 0;
  RecordPrototype.takeWhile = void 0;
  RecordPrototype.takeUntil = void 0;
});
//# sourceMappingURL=data:application/json;base64,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QyxDQUFDO0FBQzlCLGlCQUFlLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ2xDLGlCQUFlLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ25DLGlCQUFlLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ25DLGlCQUFlLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ2hDLGlCQUFlLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQzlCLGlCQUFlLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ2xDLGlCQUFlLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ25DLGlCQUFlLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDIiwiZmlsZSI6InJlY29yZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7VHlwZWQsIHR5cGVPZiwgY29uc3RydWN0fSBmcm9tIFwiLi90eXBlZFwiXG5pbXBvcnQge1NlcSwgSXRlcmFibGUsIE1hcH0gZnJvbSAnaW1tdXRhYmxlJ1xuXG5jb25zdCB7S2V5ZWR9ID0gSXRlcmFibGVcblxuY29uc3QgR2V0dGVyID0ga2V5ID0+IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gdGhpcy5nZXQoa2V5KVxufVxuXG5jb25zdCBTZXR0ZXIgPSBrZXkgPT4gZnVuY3Rpb24odmFsdWUpIHtcbiAgaWYgKCF0aGlzLl9fb3duZXJJRCkge1xuICAgIHRocm93IFR5cGVFcnJvcihcIkNhbm5vdCBzZXQgb24gYW4gaW1tdXRhYmxlIHJlY29yZC5cIilcbiAgfVxuICB0aGlzLnNldChrZXksIHZhbHVlKVxufVxuXG5cbmNvbnN0ICRzdG9yZSA9IFR5cGVkLnN0b3JlXG5jb25zdCAkdHlwZSA9IFR5cGVkLnR5cGVcbmNvbnN0ICRzdGVwID0gVHlwZWQuc3RlcFxuY29uc3QgJGluaXQgPSBUeXBlZC5pbml0XG5jb25zdCAkcmVzdWx0ID0gVHlwZWQucmVzdWx0XG5jb25zdCAkcmVhZCA9IFR5cGVkLnJlYWRcbmNvbnN0ICRsYWJlbCA9IFR5cGVkLmxhYmVsXG5jb25zdCAkZW1wdHkgPSBUeXBlZC5lbXB0eVxuY29uc3QgJHR5cGVOYW1lID0gVHlwZWQudHlwZU5hbWVcbmNvbnN0ICR0eXBlU2lnbmF0dXJlID0gVHlwZWQudHlwZVNpZ25hdHVyZVxuXG5jb25zdCBJdGVyYWJsZUtleWVkQmFzZSA9IGZ1bmN0aW9uKCkge31cbkl0ZXJhYmxlS2V5ZWRCYXNlLnByb3RvdHlwZSA9IEl0ZXJhYmxlLktleWVkLnByb3RvdHlwZVxuXG5cbmNsYXNzIFR5cGVkUmVjb3JkIGV4dGVuZHMgSXRlcmFibGVLZXllZEJhc2Uge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpXG4gIH1cbiAgW1R5cGVkLmluaXRdKCkge1xuICAgIHJldHVybiBjb25zdHJ1Y3QodGhpcykuYXNNdXRhYmxlKClcbiAgfVxuICBbVHlwZWQucmVzdWx0XShyZXN1bHQpIHtcbiAgICByZXR1cm4gcmVzdWx0LmFzSW1tdXRhYmxlKClcbiAgfVxuXG4gIFtUeXBlZC5yZWFkXShzdHJ1Y3R1cmUpIHtcbiAgICBjb25zdCBUeXBlID0gdGhpcy5jb25zdHJ1Y3RvclxuXG4gICAgaWYgKHN0cnVjdHVyZSBpbnN0YW5jZW9mIFR5cGUgJiZcbiAgICAgICAgc3RydWN0dXJlICYmXG4gICAgICAgIHN0cnVjdHVyZS5jb25zdHJ1Y3RvciA9PT0gVHlwZSkge1xuICAgICAgcmV0dXJuIHN0cnVjdHVyZVxuICAgIH1cblxuICAgIGlmIChzdHJ1Y3R1cmUgPT09IG51bGwgfHwgKHN0cnVjdHVyZSAmJiB0eXBlb2Yoc3RydWN0dXJlKSAhPT0gXCJvYmplY3RcIikpIHtcbiAgICAgIHJldHVybiBUeXBlRXJyb3IoYEludmFsaWQgZGF0YSBzdHJ1Y3R1cmUgXCIke3N0cnVjdHVyZX1cIiB3YXMgcGFzc2VkIHRvICR7dGhpc1skdHlwZU5hbWVdKCl9YClcbiAgICB9XG5cbiAgICBjb25zdCBzZXEgPSBTZXEoc3RydWN0dXJlKVxuICAgIGNvbnN0IHR5cGUgPSB0aGlzWyR0eXBlXVxuICAgIGNvbnN0IGlzRW1wdHkgPSBzZXEuc2l6ZSA9PT0gMFxuXG5cbiAgICBpZiAoaXNFbXB0eSAmJiB0aGlzWyRlbXB0eV0pIHtcbiAgICAgIHJldHVybiB0aGlzWyRlbXB0eV1cbiAgICB9XG5cbiAgICBsZXQgcmVjb3JkXG4gICAgZm9yIChsZXQga2V5IGluIHR5cGUpIHtcbiAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IHR5cGVba2V5XVxuICAgICAgY29uc3QgdmFsdWUgPSBzZXEuaGFzKGtleSkgPyBzZXEuZ2V0KGtleSkgOiB0aGlzLmdldChrZXkpXG4gICAgICBjb25zdCByZXN1bHQgPSBmaWVsZFR5cGVbJHJlYWRdKHZhbHVlKVxuXG4gICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgVHlwZUVycm9yKSB7XG4gICAgICAgIHJldHVybiBUeXBlRXJyb3IoYEludmFsaWQgdmFsdWUgZm9yIFwiJHtrZXl9XCIgZmllbGQ6XFxuICR7cmVzdWx0Lm1lc3NhZ2V9YClcbiAgICAgIH1cblxuICAgICAgcmVjb3JkID0gdGhpc1skc3RlcF0ocmVjb3JkIHx8IHRoaXNbJGluaXRdKCksIFtrZXksIHJlc3VsdF0pXG4gICAgfVxuXG4gICAgcmVjb3JkID0gdGhpc1skcmVzdWx0XShyZWNvcmQpXG5cbiAgIGlmIChpc0VtcHR5KSB7XG4gICAgICB0aGlzWyRlbXB0eV0gPSByZWNvcmRcbiAgICB9XG5cbiAgICByZXR1cm4gcmVjb3JkXG4gIH1cbiAgW1R5cGVkLnN0ZXBdKHJlc3VsdCwgW2tleSwgdmFsdWVdKSB7XG4gICAgY29uc3Qgc3RvcmUgPSByZXN1bHRbJHN0b3JlXSA/IHJlc3VsdFskc3RvcmVdLnNldChrZXksIHZhbHVlKSA6XG4gICAgICAgICAgICAgICAgICBuZXcgTWFwKFtba2V5LCB2YWx1ZV1dKVxuXG4gICAgaWYgKHJlc3VsdFskc3RvcmVdID09PSBzdG9yZSkge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBjb25zdCByZWNvcmQgPSByZXN1bHQuX19vd25lcklEID8gcmVzdWx0IDogY29uc3RydWN0KHJlc3VsdClcbiAgICByZWNvcmRbJHN0b3JlXSA9IHN0b3JlXG5cbiAgICByZXR1cm4gcmVjb3JkXG4gIH1cblxuICBbVHlwZWQudHlwZVNpZ25hdHVyZV0oKSB7XG4gICAgY29uc3QgdHlwZSA9IHRoaXNbJHR5cGVdXG4gICAgY29uc3QgYm9keSA9IFtdXG4gICAgZm9yIChsZXQga2V5IGluIHR5cGUpIHtcbiAgICAgIGJvZHkucHVzaChgJHtrZXl9OiAke3R5cGVba2V5XVskdHlwZU5hbWVdKCl9YClcbiAgICB9XG5cbiAgICByZXR1cm4gYFR5cGVkLlJlY29yZCh7JHtib2R5LmpvaW4oJywgJyl9fSlgXG4gIH1cblxuICBbVHlwZWQudHlwZU5hbWVdKCkge1xuICAgIHJldHVybiB0aGlzWyRsYWJlbF0gfHwgdGhpc1skdHlwZVNpZ25hdHVyZV0oKVxuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMuX190b1N0cmluZyh0aGlzWyR0eXBlTmFtZV0oKSArICcoeycsICd9KScpXG4gIH1cblxuICBoYXMoa2V5KSB7XG4gICAgcmV0dXJuICEhdGhpc1skdHlwZV1ba2V5XVxuICB9XG5cbiAgZ2V0KGtleSwgZGVmYXVsdFZhbHVlKSB7XG4gICAgcmV0dXJuICF0aGlzWyR0eXBlXVtrZXldID8gZGVmYXVsdFZhbHVlIDpcbiAgICAgICAgICAgIXRoaXNbJHN0b3JlXSA/IGRlZmF1bHRWYWx1ZSA6XG4gICAgICAgICAgIHRoaXNbJHN0b3JlXS5nZXQoa2V5LCBkZWZhdWx0VmFsdWUpO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgaWYgKHRoaXMuX19vd25lcklEKSB7XG4gICAgICB0aGlzWyRzdG9yZV0gJiYgdGhpc1skc3RvcmVdLmNsZWFyKClcbiAgICAgIHJldHVybiB0aGlzXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXNbJGVtcHR5XSB8fFxuICAgICAgICAgICAodGhpc1skZW1wdHldID0gbmV3IHRoaXMuY29uc3RydWN0b3IoKSlcbiAgfVxuXG4gIHJlbW92ZShrZXkpIHtcbiAgICByZXR1cm4gdGhpc1skdHlwZV1ba2V5XSA/IHRoaXMuc2V0KGtleSwgdm9pZCgwKSkgOiB0aGlzXG4gIH1cblxuICBzZXQoa2V5LCB2YWx1ZSkge1xuICAgIGNvbnN0IGZpZWxkVHlwZSA9IHRoaXNbJHR5cGVdW2tleV1cblxuICAgIGlmICghZmllbGRUeXBlKSB7XG4gICAgICB0aHJvdyBUeXBlRXJyb3IoYENhbm5vdCBzZXQgdW5rbm93biBmaWVsZCBcIiR7a2V5fVwiIG9uIFwiJHt0aGlzWyR0eXBlTmFtZV0oKX1cImApXG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gZmllbGRUeXBlWyRyZWFkXSh2YWx1ZSlcblxuICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBUeXBlRXJyb3IpIHtcbiAgICAgIHRocm93IFR5cGVFcnJvcihgSW52YWxpZCB2YWx1ZSBmb3IgJHtrZXl9IGZpZWxkOiAke3Jlc3VsdC5tZXNzYWdlfWApXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXNbJHN0ZXBdKHRoaXMsIFtrZXksIHJlc3VsdF0pXG4gIH1cbiAgX19pdGVyYXRvcih0eXBlLCByZXZlcnNlKSB7XG4gICAgcmV0dXJuIEtleWVkKHRoaXNbJHR5cGVdKS5tYXAoKF8sIGtleSkgPT4gdGhpcy5nZXQoa2V5KSkuX19pdGVyYXRvcih0eXBlLCByZXZlcnNlKTtcbiAgfVxuXG4gIF9faXRlcmF0ZShmLCByZXZlcnNlKSB7XG4gICAgcmV0dXJuIEtleWVkKHRoaXNbJHR5cGVdKS5tYXAoKF8sIGtleSkgPT4gdGhpcy5nZXQoa2V5KSkuX19pdGVyYXRlKGYsIHJldmVyc2UpO1xuICB9XG5cbiAgX19lbnN1cmVPd25lcihvd25lcklEKSB7XG4gICAgaWYgKG93bmVySUQgPT09IHRoaXMuX19vd25lcklEKSB7XG4gICAgICByZXR1cm4gdGhpc1xuICAgIH1cblxuICAgIGNvbnN0IHN0b3JlID0gdGhpc1skc3RvcmVdICYmIHRoaXNbJHN0b3JlXS5fX2Vuc3VyZU93bmVyKG93bmVySUQpXG4gICAgY29uc3QgcmVzdWx0ID0gIW93bmVySUQgPyB0aGlzIDogY29uc3RydWN0KHRoaXMpXG5cbiAgICByZXN1bHQuX19vd25lcklEID0gb3duZXJJRFxuICAgIHJlc3VsdFskc3RvcmVdID0gc3RvcmVcbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cbiAgd2FzQWx0ZXJlZCgpIHtcbiAgICByZXR1cm4gdGhpc1skc3RvcmVdLndhc0FsdGVyZWQoKVxuICB9XG59XG5cbmV4cG9ydCBjb25zdCBSZWNvcmQgPSBmdW5jdGlvbihkZXNjcmlwdG9yLCBsYWJlbCkge1xuICBpZiAoZGVzY3JpcHRvciAmJiB0eXBlb2YoZGVzY3JpcHRvcikgPT09IFwib2JqZWN0XCIpIHtcbiAgICBjb25zdCB0eXBlID0gT2JqZWN0LmNyZWF0ZShudWxsKVxuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhkZXNjcmlwdG9yKVxuICAgIGNvbnN0IHNpemUgPSBrZXlzLmxlbmd0aFxuXG4gICAgaWYgKHNpemUgPiAwKSB7XG4gICAgICBjb25zdCBwcm9wZXJ0aWVzID0ge1xuICAgICAgICBzaXplOiB7dmFsdWU6IHNpemV9LFxuICAgICAgICBbJHR5cGVdOiB7dmFsdWU6IHR5cGV9LFxuICAgICAgICBbJGxhYmVsXToge3ZhbHVlOiBsYWJlbH1cbiAgICAgIH1cblxuICAgICAgbGV0IGluZGV4ID0gMFxuICAgICAgd2hpbGUgKGluZGV4IDwgc2l6ZSkge1xuICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2luZGV4XVxuICAgICAgICBjb25zdCBmaWVsZFR5cGUgPSB0eXBlT2YoZGVzY3JpcHRvcltrZXldKVxuXG4gICAgICAgIGlmIChmaWVsZFR5cGUpIHtcbiAgICAgICAgICB0eXBlW2tleV0gPSBmaWVsZFR5cGVcbiAgICAgICAgICBwcm9wZXJ0aWVzW2tleV0gPSB7Z2V0OkdldHRlcihrZXkpLCBzZXQ6U2V0dGVyKGtleSksIGVudW1lcmFibGU6IHRydWV9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgVHlwZUVycm9yKGBJbnZhbGlkIGZpZWxkIGRlc2NyaXB0b3IgcHJvdmlkZWQgZm9yIGEgXCIke2tleX1cIiBmaWVsZGApXG4gICAgICAgIH1cblxuICAgICAgICBpbmRleCA9IGluZGV4ICsgMVxuICAgICAgfVxuXG4gICAgICBjb25zdCBSZWNvcmRUeXBlID0gZnVuY3Rpb24oc3RydWN0dXJlKSB7XG4gICAgICAgIGNvbnN0IGlzTmV3ID0gdGhpcyBpbnN0YW5jZW9mIFJlY29yZFR5cGVcbiAgICAgICAgY29uc3QgY29uc3RydWN0b3IgPSBpc05ldyA/IHRoaXMuY29uc3RydWN0b3IgOiBSZWNvcmRUeXBlXG5cbiAgICAgICAgaWYgKHN0cnVjdHVyZSBpbnN0YW5jZW9mIGNvbnN0cnVjdG9yKSB7XG4gICAgICAgICAgcmV0dXJuIHN0cnVjdHVyZVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdHlwZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZVxuICAgICAgICBjb25zdCByZXN1bHQgPSB0eXBlWyRyZWFkXShzdHJ1Y3R1cmUpXG5cbiAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFR5cGVFcnJvcikge1xuICAgICAgICAgIHRocm93IHJlc3VsdFxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGlzTmV3KSB7XG4gICAgICAgICAgdGhpc1skc3RvcmVdID0gcmVzdWx0WyRzdG9yZV1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcHJvcGVydGllcy5jb25zdHJ1Y3RvciA9IHt2YWx1ZTogUmVjb3JkVHlwZX1cbiAgICAgIFJlY29yZFR5cGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSZWNvcmRQcm90b3R5cGUsIHByb3BlcnRpZXMpXG4gICAgICBjb25zdCBwcm90b3R5cGUgPSBSZWNvcmRUeXBlLnByb3RvdHlwZVxuXG4gICAgICByZXR1cm4gUmVjb3JkVHlwZVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBUeXBlRXJyb3IoYFR5cGVkLlJlY29yZCBkZXNjcmlwdG9yIG11c3QgZGVmaW5lIGF0IGxlYXN0IG9uIGZpZWxkYClcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgVHlwZUVycm9yKGBUeXBlZC5SZWNvcmQgbXVzdCBiZSBwYXNzZWQgYSBkZXNjcmlwdG9yIG9mIGZpZWxkc2ApXG4gIH1cbn1cblJlY29yZC5UeXBlID0gVHlwZWRSZWNvcmRcblJlY29yZC5wcm90b3R5cGUgPSBUeXBlZFJlY29yZC5wcm90b3R5cGVcbmNvbnN0IFJlY29yZFByb3RvdHlwZSA9IFR5cGVkUmVjb3JkLnByb3RvdHlwZVxuXG5cblJlY29yZFByb3RvdHlwZVtUeXBlZC5ERUxFVEVdID0gUmVjb3JkUHJvdG90eXBlLnJlbW92ZVxuXG4vLyBMYXJnZSBwYXJ0IG9mIHRoZSBSZWNvcmQgQVBJIGlzIGltcGxlbWVudGVkIGJ5IEltbXV0YWJlbC5NYXBcbi8vIGFuZCBpcyBqdXN0IGNvcGllZCBvdmVyLlxuUmVjb3JkUHJvdG90eXBlLmRlbGV0ZUluID0gTWFwLnByb3RvdHlwZS5kZWxldGVJblxuUmVjb3JkUHJvdG90eXBlLnJlbW92ZUluID0gTWFwLnByb3RvdHlwZS5yZW1vdmVJblxuUmVjb3JkUHJvdG90eXBlLm1lcmdlID0gTWFwLnByb3RvdHlwZS5tZXJnZVxuUmVjb3JkUHJvdG90eXBlLm1lcmdlV2l0aCA9IE1hcC5wcm90b3R5cGUubWVyZ2VXaXRoXG5SZWNvcmRQcm90b3R5cGUubWVyZ2VJbiA9IE1hcC5wcm90b3R5cGUubWVyZ2VJblxuUmVjb3JkUHJvdG90eXBlLm1lcmdlRGVlcCA9IE1hcC5wcm90b3R5cGUubWVyZ2VEZWVwXG5SZWNvcmRQcm90b3R5cGUubWVyZ2VEZWVwV2l0aCA9IE1hcC5wcm90b3R5cGUubWVyZ2VEZWVwV2l0aFxuUmVjb3JkUHJvdG90eXBlLm1lcmdlRGVlcEluID0gTWFwLnByb3RvdHlwZS5tZXJnZURlZXBJblxuUmVjb3JkUHJvdG90eXBlLnNldEluID0gTWFwLnByb3RvdHlwZS5zZXRJblxuUmVjb3JkUHJvdG90eXBlLnVwZGF0ZSA9IE1hcC5wcm90b3R5cGUudXBkYXRlXG5SZWNvcmRQcm90b3R5cGUudXBkYXRlSW4gPSBNYXAucHJvdG90eXBlLnVwZGF0ZUluXG5SZWNvcmRQcm90b3R5cGUud2l0aE11dGF0aW9ucyA9IE1hcC5wcm90b3R5cGUud2l0aE11dGF0aW9uc1xuUmVjb3JkUHJvdG90eXBlLmFzTXV0YWJsZSA9IE1hcC5wcm90b3R5cGUuYXNNdXRhYmxlXG5SZWNvcmRQcm90b3R5cGUuYXNJbW11dGFibGUgPSBNYXAucHJvdG90eXBlLmFzSW1tdXRhYmxlXG5cbi8vIExhcmdlIGNodWNrIG9mIEFQSSBpbmhlcml0ZWQgZnJvbSBJdGVyYWJsZSBkb2VzIG5vdCBtYWtlc1xuLy8gbXVjaCBzZW5zZSBpbiB0aGUgY29udGV4dCBvZiByZWNvcmRzIHNvIHdlIHVuZGVmaW5lIGl0LlxuUmVjb3JkUHJvdG90eXBlLm1hcCA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5maWx0ZXIgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuZmlsdGVyTm90ID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLmZsaXAgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUubWFwS2V5cyA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5tYXBFbnRyaWVzID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnNvcnQgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuc29ydEJ5ID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnJldmVyc2UgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuc2xpY2UgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuYnV0TGFzdCA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5mbGF0TWFwID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLmZsYXR0ZW4gPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUucmVzdCA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5za2lwID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnNraXBMYXN0ID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnNraXBXaGlsZSA9IHZvaWQoMClcblJlY29yZFByb3RvdHlwZS5za2lwVW50aWwgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUuc29ydEJ5ID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnRha2UgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUudGFrZUxhc3QgPSB2b2lkKDApXG5SZWNvcmRQcm90b3R5cGUudGFrZVdoaWxlID0gdm9pZCgwKVxuUmVjb3JkUHJvdG90eXBlLnRha2VVbnRpbCA9IHZvaWQoMClcbiJdfQ==